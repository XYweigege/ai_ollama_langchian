<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM API æµ‹è¯•å¹³å°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    // Tailwindé…ç½®
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#10b981',
            dark: '#1e293b',
            light: '#f8fafc'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .glassmorphism {
        @apply bg-white/70 backdrop-blur-lg shadow-lg;
      }
      .transition-all-300 {
        @apply transition-all duration-300 ease-in-out;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-inter">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="mb-8 text-center">
      <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-transparent bg-clip-text bg-gradient-to-r from-primary to-indigo-600">
        ğŸ”® LLM API æµ‹è¯•å¹³å°
      </h1>
      <p class="text-gray-600 mt-2 text-lg">è¿æ¥æœ¬åœ° Ollama æœåŠ¡ï¼Œæµ‹è¯• AI æ¨¡å‹èƒ½åŠ›</p>
    </header>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
      <div class="lg:col-span-1">
        <div class="glassmorphism rounded-2xl p-6 border border-gray-200 h-full">
          <h2 class="text-xl font-bold text-dark mb-4 flex items-center">
            <i class="fa fa-sliders mr-2 text-primary"></i> è®¾ç½®
          </h2>
          
          <!-- æ¨¡å‹é€‰æ‹© -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">æ¨¡å‹é€‰æ‹©</label>
            <div class="relative">
              <select id="model-select" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all-300">
                <option value="deepseek-r1:1.5b">deepseek-r1:1.5b</option>
                <option value="qwen3:0.6b">qwen3:0.6b</option>
                <!-- <option value="llama2">Llama 2</option>
                <option value="mistral">Mistral</option> -->
              </select>
              <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                <i class="fa fa-chevron-down"></i>
              </div>
            </div>
          </div>

          <!-- ç”Ÿæˆå‚æ•° -->
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">æ¸©åº¦ (Creativity)</label>
              <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" 
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
              <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span>0.0 (ç²¾ç¡®)</span>
                <span id="temp-value">0.7</span>
                <span>2.0 (éšæœº)</span>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">æœ€å¤§ token</label>
              <input type="range" id="max-tokens" min="100" max="4096" step="100" value="1024" 
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
              <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span>100</span>
                <span id="tokens-value">1024</span>
                <span>4096</span>
              </div>
            </div>
          </div>

          <!-- API çŠ¶æ€ -->
          <div class="mt-6 pt-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-gray-700">API è¿æ¥çŠ¶æ€</span>
              <div id="status-indicator" class="flex items-center">
                <span id="status-dot" class="w-3 h-3 rounded-full bg-yellow-400 mr-2 animate-pulse"></span>
                <span id="status-text" class="text-sm text-gray-600">æ£€æŸ¥ä¸­...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§èŠå¤©ç•Œé¢ -->
      <div class="lg:col-span-2">
        <div class="glassmorphism rounded-2xl border border-gray-200 flex flex-col h-[600px]">
          <!-- èŠå¤©å†å² -->
          <div id="chat-history" class="flex-1 overflow-y-auto p-6 space-y-4">
            <div class="flex items-start">
              <div class="bg-blue-500 rounded-full w-8 h-8 flex items-center justify-center text-white flex-shrink-0">
                <i class="fa fa-robot"></i>
              </div>
              <div class="ml-3 bg-blue-50 rounded-lg p-4 max-w-[85%]">
                <p class="text-gray-800">ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯åŸºäºæœ¬åœ° Ollama æœåŠ¡çš„ AI åŠ©æ‰‹ã€‚è¯·è¾“å…¥ä½ çš„é—®é¢˜æˆ–æç¤ºï¼Œæˆ‘ä¼šå°½åŠ›ä¸ºä½ æä¾›å¸®åŠ©ã€‚</p>
              </div>
            </div>
          </div>

          <!-- è¾“å…¥åŒºåŸŸ -->
          <div class="p-4 border-t border-gray-200">
            <div class="relative">
              <textarea id="user-input" rows="3" placeholder="è¾“å…¥ä½ çš„é—®é¢˜æˆ–æç¤º..." 
                class="w-full px-4 py-3 pr-12 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all-300 resize-none"></textarea>
              <button id="send-btn" class="absolute bottom-3 right-3 bg-primary hover:bg-primary/90 text-white p-2 rounded-full transition-all-300">
                <i class="fa fa-paper-plane"></i>
              </button>
            </div>
            <div class="mt-3 flex space-x-2">
              <button id="generate-btn" class="flex-1 bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg transition-all-300 flex items-center justify-center">
                <i class="fa fa-magic mr-2"></i> ç”Ÿæˆå›ç­”
              </button>
              <button id="stream-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition-all-300 flex items-center justify-center">
                <i class="fa fa-random mr-2"></i> æµå¼ç”Ÿæˆ
              </button>
              <button id="clear-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-4 rounded-lg transition-all-300">
                <i class="fa fa-refresh"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- API ä½¿ç”¨è¯´æ˜ -->
    <div class="mt-12 glassmorphism rounded-2xl p-6 border border-gray-200">
      <h2 class="text-xl font-bold text-dark mb-4 flex items-center">
        <i class="fa fa-code mr-2 text-primary"></i> API ä½¿ç”¨è¯´æ˜
      </h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-md font-semibold text-gray-800 mb-2">è·å–æ¨¡å‹åˆ—è¡¨</h3>
          <pre class="bg-gray-800 text-gray-100 p-3 rounded-lg text-sm overflow-x-auto">GET /api/llm/models</pre>
        </div>
        
        <div>
          <h3 class="text-md font-semibold text-gray-800 mb-2">ç”Ÿæˆæ–‡æœ¬</h3>
          <pre class="bg-gray-800 text-gray-100 p-3 rounded-lg text-sm overflow-x-auto">POST /api/llm/generate
{"prompt": "ä½ çš„æç¤ºè¯", "model": "deepseek-coder"}</pre>
        </div>
        
        <div>
          <h3 class="text-md font-semibold text-gray-800 mb-2">æµå¼ç”Ÿæˆ</h3>
          <pre class="bg-gray-800 text-gray-100 p-3 rounded-lg text-sm overflow-x-auto">POST /api/llm/stream
{"prompt": "ä½ çš„æç¤ºè¯", "model": "deepseek-coder"}</pre>
        </div>
        
        <div>
          <h3 class="text-md font-semibold text-gray-800 mb-2">èŠå¤©å¯¹è¯</h3>
          <pre class="bg-gray-800 text-gray-100 p-3 rounded-lg text-sm overflow-x-auto">POST /api/llm/chat
{"messages": [{"role": "user", "content": "ä½ å¥½"}], "model": "deepseek-coder"}</pre>
        </div>
      </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="mt-12 text-center text-gray-600 text-sm">
      <p>LLM API æµ‹è¯•å¹³å° &copy; 2024 | è¿æ¥æœ¬åœ° Ollama æœåŠ¡</p>
    </footer>
  </div>

  <script>
    // DOM å…ƒç´ 
    const modelSelect = document.getElementById('model-select');
    const temperatureInput = document.getElementById('temperature');
    const maxTokensInput = document.getElementById('max-tokens');
    const tempValue = document.getElementById('temp-value');
    const tokensValue = document.getElementById('tokens-value');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const generateBtn = document.getElementById('generate-btn');
    const clearBtn = document.getElementById('clear-btn');
    const chatHistory = document.getElementById('chat-history');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');

    // å®æ—¶æ›´æ–°æ»‘å—å€¼æ˜¾ç¤º
    temperatureInput.addEventListener('input', () => {
      tempValue.textContent = temperatureInput.value;
    });

    maxTokensInput.addEventListener('input', () => {
      tokensValue.textContent = maxTokensInput.value;
    });

    // å‘é€æ¶ˆæ¯å‡½æ•°
    async function sendMessage() {
      const prompt = userInput.value.trim();
      if (!prompt) return;

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©å†å²
      addMessageToHistory('user', prompt);
      userInput.value = '';

      // æ·»åŠ  AI æ­£åœ¨è¾“å…¥çš„å ä½ç¬¦
      const aiMessageElement = addMessageToHistory('assistant', '<span class="text-gray-500">æ€è€ƒä¸­...</span>', true);

      try {
        const response = await fetch('http://localhost:3000/api/llm/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            prompt,
            model: modelSelect.value,
            options: {
              temperature: parseFloat(temperatureInput.value),
              maxTokens: parseInt(maxTokensInput.value)
            }
          })
        });

        const data = await response.json();
        
        if (data.success) {
          // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºAIå›å¤
          const responseText = data.data.text;
          // æ¸…ç©ºpæ ‡ç­¾å†…å®¹ä½†ä¿ç•™æ ‡ç­¾
          const messageParagraph = aiMessageElement.querySelector('p');
          messageParagraph.textContent = '';
          // åº”ç”¨æ‰“å­—æœºæ•ˆæœ
          typewriterEffect(responseText, messageParagraph);
        } else {
          // é”™è¯¯æ¶ˆæ¯ä¹Ÿä½¿ç”¨æ‰“å­—æœºæ•ˆæœ
          const errorText = `é”™è¯¯: ${data.error}`;
          const messageParagraph = aiMessageElement.querySelector('p');
          messageParagraph.className = 'text-red-500';
          messageParagraph.textContent = '';
          typewriterEffect(errorText, messageParagraph);
        }
      } catch (error) {
        // å¼‚å¸¸æ¶ˆæ¯ä¹Ÿä½¿ç”¨æ‰“å­—æœºæ•ˆæœ
        const errorText = `è¯·æ±‚å¤±è´¥: ${error.message}`;
        const messageParagraph = aiMessageElement.querySelector('p');
        messageParagraph.className = 'text-red-500';
        messageParagraph.textContent = '';
        typewriterEffect(errorText, messageParagraph);
      }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å†å²
    function addMessageToHistory(role, content, isLoading = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = role === 'user' ? 'flex items-start justify-end' : 'flex items-start';
      
      let avatarHtml = '';
      let messageClass = '';
      
      if (role === 'user') {
        avatarHtml = `<div class="bg-gray-300 rounded-full w-8 h-8 flex items-center justify-center text-gray-700 flex-shrink-0">
                      <i class="fa fa-user"></i>
                    </div>`;
        messageClass = 'bg-primary text-white rounded-lg p-4 max-w-[85%]';
        messageDiv.innerHTML = `
          <div class="${messageClass}">
            <p>${content}</p>
          </div>
          <div class="ml-3">${avatarHtml}</div>
        `;
      } else {
        avatarHtml = `<div class="bg-blue-500 rounded-full w-8 h-8 flex items-center justify-center text-white flex-shrink-0">
                      <i class="fa fa-robot"></i>
                    </div>`;
        messageClass = 'bg-blue-50 text-gray-800 rounded-lg p-4 max-w-[85%]';
        messageDiv.innerHTML = `
          <div>${avatarHtml}</div>
          <div class="ml-3 ${messageClass}">
            <p>${content}</p>
          </div>
        `;
      }
      
      chatHistory.appendChild(messageDiv);
      chatHistory.scrollTop = chatHistory.scrollHeight;
      
      return messageDiv;
    }

    /**
     * æ‰“å­—æœºæ•ˆæœå‡½æ•°
     * @param {string} text - è¦æ˜¾ç¤ºçš„æ–‡æœ¬
     * @param {HTMLElement} element - ç›®æ ‡DOMå…ƒç´ 
     * @param {number} speed - æ‰“å­—é€Ÿåº¦ï¼ˆæ¯«ç§’/å­—ç¬¦ï¼‰
     * @param {Function} callback - å®Œæˆåçš„å›è°ƒå‡½æ•°
     */
    function typewriterEffect(text, element, speed = 30, callback = null) {
      let index = 0;
      element.textContent = '';
      
      // æ·»åŠ å…‰æ ‡é—ªçƒæ•ˆæœ
      const cursor = document.createElement('span');
      cursor.className = 'inline-block ml-1 w-1 h-4 bg-gray-600 animate-pulse';
      element.appendChild(cursor);
      
      function typeNextChar() {
        if (index < text.length) {
          // ç§»é™¤å…‰æ ‡ï¼Œæ·»åŠ å­—ç¬¦ï¼Œå†æ·»åŠ å…‰æ ‡
          element.removeChild(cursor);
          element.textContent += text.charAt(index);
          element.appendChild(cursor);
          index++;
          
          // æ ¹æ®å­—ç¬¦è°ƒæ•´é€Ÿåº¦ï¼Œæ ‡ç‚¹ç¬¦å·åœç•™æ—¶é—´æ›´é•¿
          const char = text.charAt(index - 1);
          const currentSpeed = ['.', '!', '?'].includes(char) ? speed * 3 : 
                             [',', ';', ':'].includes(char) ? speed * 2 : speed;
          
          setTimeout(typeNextChar, currentSpeed);
        } else {
          // å®Œæˆåç§»é™¤å…‰æ ‡
          element.removeChild(cursor);
          if (callback && typeof callback === 'function') {
            callback();
          }
        }
      }
      
      typeNextChar();
    }

    // æ¸…é™¤èŠå¤©å†å²
    function clearChatHistory() {
      chatHistory.innerHTML = '';
      addMessageToHistory('assistant', 'ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯åŸºäºæœ¬åœ° Ollama æœåŠ¡çš„ AI åŠ©æ‰‹ã€‚è¯·è¾“å…¥ä½ çš„é—®é¢˜æˆ–æç¤ºï¼Œæˆ‘ä¼šå°½åŠ›ä¸ºä½ æä¾›å¸®åŠ©ã€‚');
    }

    // æ£€æŸ¥ API å¥åº·çŠ¶æ€
    async function checkApiHealth() {
      try {
        const response = await fetch('http://localhost:3000/api/llm/health');
        const data = await response.json();
        
        if (data.success) {
          statusDot.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
          statusText.textContent = 'å·²è¿æ¥';
          statusText.className = 'text-sm text-green-600';
        } else {
          statusDot.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
          statusText.textContent = 'æœªè¿æ¥';
          statusText.className = 'text-sm text-red-600';
        }
      } catch (error) {
        statusDot.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
        statusText.textContent = 'æœåŠ¡æœªå¯åŠ¨';
        statusText.className = 'text-sm text-red-600';
      }
    }

    // äº‹ä»¶ç›‘å¬å™¨
    sendBtn.addEventListener('click', sendMessage);
    generateBtn.addEventListener('click', sendMessage);
    clearBtn.addEventListener('click', clearChatHistory);
    
    // æ·»åŠ æµå¼ç”ŸæˆæŒ‰é’®äº‹ä»¶ç›‘å¬
      document.getElementById('stream-btn').addEventListener('click', async function() {
        const message = document.getElementById('message-input').value.trim();
        if (!message) return;
        
        const selectedModel = document.getElementById('model-select').value;
        const temperature = document.getElementById('temperature-slider').value;
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
        addMessageToHistory('user', message);
        document.getElementById('message-input').value = '';
        
        // æ·»åŠ AIæ¶ˆæ¯å ä½ç¬¦
        const aiMessageElement = addMessageToHistory('ai', '');
        const messageParagraph = aiMessageElement.querySelector('p');
        
        try {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          setLoading(true);
          
          // è°ƒç”¨æµå¼ç”ŸæˆAPI
          const response = await fetch('/api/llm/stream', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              prompt: message,
              model: selectedModel,
              options: {
                temperature: parseFloat(temperature)
              }
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            messageParagraph.className = 'text-red-500';
            messageParagraph.textContent = '';
            typewriterEffect(`é”™è¯¯: ${errorData.error || 'è¯·æ±‚å¤±è´¥'}`, messageParagraph);
            return;
          }
          
          // å¤„ç†SSEå“åº”
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let accumulatedText = '';
          
          // æ·»åŠ å…‰æ ‡
          const cursor = document.createElement('span');
          cursor.className = 'inline-block w-2 h-5 bg-gray-500 ml-1 animate-pulse';
          messageParagraph.appendChild(cursor);
          
          // è§£æSSEæ ¼å¼
          const parseSSE = (data) => {
            const lines = data.split('\n');
            let events = [];
            
            lines.forEach(line => {
              if (line.startsWith('data:')) {
                try {
                  const eventData = JSON.parse(line.substring(5).trim());
                  events.push(eventData);
                } catch (e) {
                  console.error('è§£æSSEæ•°æ®å¤±è´¥:', e);
                }
              }
            });
            
            return events;
          };
          
          // æµå¼è¯»å–å“åº”
          while (true) {
            const { value, done } = await reader.read();
            
            if (done) {
              break;
            }
            
            if (value) {
              // è§£ç å¹¶å¤„ç†SSEæ ¼å¼çš„æ•°æ®
              const chunk = decoder.decode(value, { stream: true });
              const events = parseSSE(chunk);
              
              // å¤„ç†æ¯ä¸ªäº‹ä»¶
              events.forEach(event => {
                if (event.chunk) {
                  accumulatedText += event.chunk;
                  
                  // æ›´æ–°æ˜¾ç¤ºï¼ˆç§»é™¤å…‰æ ‡ï¼Œæ›´æ–°æ–‡æœ¬ï¼Œé‡æ–°æ·»åŠ å…‰æ ‡ï¼‰
                  if (cursor.parentNode) {
                    messageParagraph.removeChild(cursor);
                  }
                  messageParagraph.textContent = accumulatedText;
                  messageParagraph.appendChild(cursor);
                  
                  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                  messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
              });
            }
          }
          
          // ç§»é™¤å…‰æ ‡
          if (cursor.parentNode) {
            messageParagraph.removeChild(cursor);
          }
          
          // æ›´æ–°çŠ¶æ€ä¸ºæˆåŠŸ
          aiMessageElement.querySelector('.message-status').textContent = 'âœ…';
        } catch (error) {
          // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
          messageParagraph.className = 'text-red-500';
          messageParagraph.textContent = '';
          typewriterEffect(`è¯·æ±‚å¤±è´¥: ${error.message}`, messageParagraph);
        } finally {
          setLoading(false);
        }
      });
    
    // æŒ‰ä¸‹ Ctrl+Enter å‘é€æ¶ˆæ¯
    userInput.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ API å¥åº·çŠ¶æ€
    window.addEventListener('load', () => {
      checkApiHealth();
      // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡å¥åº·çŠ¶æ€
      setInterval(checkApiHealth, 60000);
    });
  </script>
</body>
</html>